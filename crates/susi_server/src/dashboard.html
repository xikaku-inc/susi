<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FusionHub License Server</title>
<style>
:root {
    --bg: #0f1117;
    --bg2: #1a1d27;
    --bg3: #242836;
    --border: #2e3348;
    --text: #e0e0e8;
    --text2: #8b8fa8;
    --accent: #6c8cff;
    --accent-hover: #8ba4ff;
    --green: #4ade80;
    --red: #f87171;
    --yellow: #fbbf24;
    --radius: 8px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
}
a { color: var(--accent); text-decoration: none; }
a:hover { color: var(--accent-hover); }

.header {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.header h1 { font-size: 18px; font-weight: 600; }
.header .status { font-size: 13px; color: var(--text2); }
.header .status.ok { color: var(--green); }
.header .status.err { color: var(--red); }

.container { max-width: 1200px; margin: 0 auto; padding: 24px; }

.toolbar {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
}
.toolbar .spacer { flex: 1; }

button {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: background 0.15s;
}
button:hover { background: var(--accent-hover); }
button.secondary {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text);
}
button.secondary:hover { background: var(--border); }
button.danger { background: var(--red); }
button.danger:hover { background: #ef4444; }
button.small { padding: 4px 10px; font-size: 12px; }

input, select {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: var(--radius);
    font-size: 13px;
    outline: none;
}
input:focus, select:focus { border-color: var(--accent); }
input::placeholder { color: var(--text2); }

label {
    display: block;
    font-size: 12px;
    color: var(--text2);
    margin-bottom: 4px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
}

.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
}
.stat-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
}
.stat-card .value { font-size: 28px; font-weight: 700; }
.stat-card .label { font-size: 12px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; }

table { width: 100%; border-collapse: collapse; }
th {
    text-align: left;
    padding: 10px 14px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text2);
    background: var(--bg3);
    border-bottom: 1px solid var(--border);
    font-weight: 600;
}
td {
    padding: 10px 14px;
    font-size: 13px;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
}
tr:last-child td { border-bottom: none; }
tr:hover td { background: rgba(108, 140, 255, 0.04); }

.badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}
.badge.active { background: rgba(74, 222, 128, 0.15); color: var(--green); }
.badge.expired { background: rgba(251, 191, 36, 0.15); color: var(--yellow); }
.badge.revoked { background: rgba(248, 113, 113, 0.15); color: var(--red); }

.feature-tag {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 4px;
    font-size: 11px;
    background: var(--bg3);
    border: 1px solid var(--border);
    margin: 1px 2px;
}

.key-display {
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
    font-size: 12px;
    background: var(--bg);
    padding: 2px 6px;
    border-radius: 4px;
    user-select: all;
}

/* Modal */
.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 100;
    justify-content: center;
    align-items: flex-start;
    padding-top: 80px;
}
.modal-overlay.visible { display: flex; }
.modal {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 100%;
    max-width: 520px;
    padding: 24px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}
.modal h2 { font-size: 16px; margin-bottom: 16px; }
.modal .form-row {
    margin-bottom: 12px;
}
.modal .form-row input,
.modal .form-row select {
    width: 100%;
}
.modal .form-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 20px;
}

.toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 12px 20px;
    border-radius: var(--radius);
    font-size: 13px;
    z-index: 200;
    animation: slideIn 0.2s ease-out;
    max-width: 400px;
}
.toast.success { background: rgba(74, 222, 128, 0.15); border: 1px solid var(--green); color: var(--green); }
.toast.error { background: rgba(248, 113, 113, 0.15); border: 1px solid var(--red); color: var(--red); }
@keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.empty-state {
    text-align: center;
    padding: 48px 24px;
    color: var(--text2);
}
.empty-state p { font-size: 14px; margin-bottom: 16px; }

/* Detail panel */
.detail-panel {
    display: none;
    margin-bottom: 20px;
}
.detail-panel.visible { display: block; }
.detail-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px;
    background: var(--bg3);
    border-bottom: 1px solid var(--border);
}
.detail-header h3 { font-size: 14px; }
.detail-body { padding: 14px; }
.detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
}
.detail-field .field-label { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; }
.detail-field .field-value { font-size: 14px; margin-top: 2px; }
.detail-section-title {
    font-size: 12px;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 16px 0 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border);
}

.machines-list { margin-top: 4px; }
.machine-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: var(--bg);
    border-radius: var(--radius);
    margin-bottom: 4px;
    font-size: 13px;
}
.machine-item .machine-code {
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
    font-size: 11px;
    color: var(--text2);
}

/* Search */
#searchInput { min-width: 200px; }

/* Auth overlays */
.auth-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 300;
    justify-content: center;
    align-items: center;
}
.auth-overlay.visible { display: flex; }
.auth-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 32px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}
.auth-card h2 { font-size: 18px; margin-bottom: 4px; }
.auth-card .subtitle { font-size: 13px; color: var(--text2); margin-bottom: 20px; }
.auth-card .form-row { margin-bottom: 14px; }
.auth-card .form-row input { width: 100%; }
.auth-card .auth-error {
    background: rgba(248, 113, 113, 0.1);
    border: 1px solid var(--red);
    color: var(--red);
    padding: 8px 12px;
    border-radius: var(--radius);
    font-size: 13px;
    margin-bottom: 14px;
    display: none;
}
.auth-card .auth-error.visible { display: block; }
.auth-card button { width: 100%; padding: 10px; font-size: 14px; }
.auth-card button + button { margin-top: 8px; }

/* 2FA modal extras */
.qr-container { text-align: center; margin: 16px 0; }
.qr-container img { max-width: 200px; border-radius: var(--radius); background: #fff; padding: 8px; }
.secret-display {
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
    font-size: 13px;
    background: var(--bg);
    padding: 8px 12px;
    border-radius: var(--radius);
    text-align: center;
    user-select: all;
    word-break: break-all;
    margin: 8px 0;
}

/* Header buttons */
.header-actions { display: flex; gap: 8px; align-items: center; }

@media (max-width: 768px) {
    .container { padding: 12px; }
    .detail-grid { grid-template-columns: 1fr; }
    table { font-size: 12px; }
    th, td { padding: 8px 10px; }
}
</style>
</head>
<body>

<div class="header">
    <h1>FusionHub License Server</h1>
    <div class="header-actions">
        <span id="connectionStatus" class="status">Connecting...</span>
        <button id="btnUsers" class="small secondary" onclick="showUsersModal()" style="display:none;">Users</button>
        <button id="btn2FA" class="small secondary" onclick="show2FAModal()" style="display:none;">2FA</button>
        <span id="currentUser" style="display:none;font-size:13px;color:var(--text2);"></span>
        <button id="btnLogout" class="small secondary" onclick="logout()" style="display:none;">Logout</button>
    </div>
</div>

<div class="container">
    <div class="stats">
        <div class="stat-card">
            <div class="value" id="statTotal">-</div>
            <div class="label">Total Licenses</div>
        </div>
        <div class="stat-card">
            <div class="value" id="statActive" style="color: var(--green);">-</div>
            <div class="label">Active</div>
        </div>
        <div class="stat-card">
            <div class="value" id="statExpired" style="color: var(--yellow);">-</div>
            <div class="label">Expired</div>
        </div>
        <div class="stat-card">
            <div class="value" id="statRevoked" style="color: var(--red);">-</div>
            <div class="label">Revoked</div>
        </div>
    </div>

    <div class="toolbar">
        <input type="text" id="searchInput" placeholder="Search licenses...">
        <div class="spacer"></div>
        <button class="secondary" onclick="loadLicenses()">Refresh</button>
        <button onclick="showCreateModal()">+ New License</button>
    </div>

    <!-- Detail panel -->
    <div id="detailPanel" class="detail-panel card">
        <div class="detail-header">
            <h3 id="detailTitle">License Details</h3>
            <div>
                <button class="small secondary" onclick="exportLicense()">Export</button>
                <button class="small danger" id="btnRevoke" onclick="revokeLicense()">Revoke</button>
                <button class="small secondary" onclick="closeDetail()">&times; Close</button>
            </div>
        </div>
        <div class="detail-body">
            <div class="detail-grid">
                <div class="detail-field">
                    <div class="field-label">License Key</div>
                    <div class="field-value" id="detailKey"></div>
                </div>
                <div class="detail-field">
                    <div class="field-label">Status</div>
                    <div class="field-value" id="detailStatus"></div>
                </div>
                <div class="detail-field">
                    <div class="field-label">Product</div>
                    <div class="field-value" id="detailProduct"></div>
                </div>
                <div class="detail-field">
                    <div class="field-label">Customer</div>
                    <div class="field-value" id="detailCustomer"></div>
                </div>
                <div class="detail-field">
                    <div class="field-label">Created</div>
                    <div class="field-value" id="detailCreated"></div>
                </div>
                <div class="detail-field">
                    <div class="field-label">Expires</div>
                    <div class="field-value" id="detailExpires"></div>
                </div>
                <div class="detail-field">
                    <div class="field-label">Features</div>
                    <div class="field-value" id="detailFeatures"></div>
                </div>
                <div class="detail-field">
                    <div class="field-label">Machines</div>
                    <div class="field-value" id="detailMachineCount"></div>
                </div>
            </div>
            <div class="detail-section-title">Activated Machines</div>
            <div id="detailMachines" class="machines-list"></div>
        </div>
    </div>

    <!-- License table -->
    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>Key</th>
                    <th>Customer</th>
                    <th>Product</th>
                    <th>Status</th>
                    <th>Expires</th>
                    <th>Machines</th>
                    <th>Features</th>
                </tr>
            </thead>
            <tbody id="licenseTableBody">
                <tr><td colspan="7" class="empty-state"><p>Loading...</p></td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Create License Modal -->
<div id="createModal" class="modal-overlay" onclick="if(event.target===this)closeCreateModal()">
    <div class="modal">
        <h2>Create New License</h2>
        <div class="form-row">
            <label>Customer</label>
            <input type="text" id="createCustomer" placeholder="Company name">
        </div>
        <div class="form-row">
            <label>Product</label>
            <input type="text" id="createProduct" value="FusionHub">
        </div>
        <div class="form-row">
            <label>Expiry</label>
            <select id="createExpiryType" onchange="updateExpiryFields()">
                <option value="days">Days from now</option>
                <option value="date">Specific date</option>
                <option value="perpetual">Perpetual</option>
            </select>
        </div>
        <div class="form-row" id="createExpiryValueRow">
            <label id="createExpiryValueLabel">Days</label>
            <input type="text" id="createExpiryValue" value="365">
        </div>
        <div class="form-row">
            <label>Features (comma-separated)</label>
            <input type="text" id="createFeatures" placeholder="full_fusion, vehicular, recorder">
        </div>
        <div class="form-row">
            <label>Max Machines (0 = unlimited)</label>
            <input type="number" id="createMaxMachines" value="1" min="0">
        </div>
        <div class="form-actions">
            <button class="secondary" onclick="closeCreateModal()">Cancel</button>
            <button onclick="createLicense()">Create License</button>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div id="exportModal" class="modal-overlay" onclick="if(event.target===this)closeExportModal()">
    <div class="modal">
        <h2>Export Signed License File</h2>
        <div class="form-row">
            <label>License Key</label>
            <input type="text" id="exportKey" readonly>
        </div>
        <div class="form-row">
            <label>Machine Code (SHA256 fingerprint)</label>
            <input type="text" id="exportMachineCode" placeholder="Paste machine fingerprint here">
        </div>
        <div class="form-row">
            <label>Friendly Name</label>
            <input type="text" id="exportFriendlyName" placeholder="e.g. Vehicle-ECU-1">
        </div>
        <div class="form-actions">
            <button class="secondary" onclick="closeExportModal()">Cancel</button>
            <button onclick="doExport()">Export &amp; Download</button>
        </div>
    </div>
</div>

<!-- Login overlay -->
<div id="loginOverlay" class="auth-overlay">
    <div class="auth-card">
        <h2>Login</h2>
        <div class="subtitle">FusionHub License Server</div>
        <div id="loginError" class="auth-error"></div>
        <div class="form-row">
            <label>Username</label>
            <input type="text" id="loginUsername" placeholder="Username" autocomplete="username" onkeydown="if(event.key==='Enter')document.getElementById('loginPassword').focus()">
        </div>
        <div class="form-row">
            <label>Password</label>
            <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password" onkeydown="if(event.key==='Enter')submitLogin()">
        </div>
        <div id="loginTotpRow" class="form-row" style="display:none;">
            <label>2FA Code</label>
            <input type="text" id="loginTotp" placeholder="6-digit code" maxlength="6" autocomplete="one-time-code" onkeydown="if(event.key==='Enter')submitLogin()">
        </div>
        <button onclick="submitLogin()">Sign In</button>
    </div>
</div>

<!-- Forced password change overlay -->
<div id="changePasswordOverlay" class="auth-overlay">
    <div class="auth-card">
        <h2>Change Password</h2>
        <div class="subtitle">You must change the default password before continuing.</div>
        <div id="changePasswordError" class="auth-error"></div>
        <div class="form-row">
            <label>Current Password</label>
            <input type="password" id="cpCurrent" placeholder="Current password">
        </div>
        <div class="form-row">
            <label>New Password (min 8 chars)</label>
            <input type="password" id="cpNew" placeholder="New password">
        </div>
        <div class="form-row">
            <label>Confirm New Password</label>
            <input type="password" id="cpConfirm" placeholder="Confirm password" onkeydown="if(event.key==='Enter')submitChangePassword()">
        </div>
        <button onclick="submitChangePassword()">Change Password</button>
    </div>
</div>

<!-- 2FA Settings Modal -->
<div id="tfaModal" class="modal-overlay" onclick="if(event.target===this)closeTFAModal()">
    <div class="modal">
        <h2>Two-Factor Authentication</h2>
        <div id="tfaContent"></div>
        <div class="form-actions">
            <button class="secondary" onclick="closeTFAModal()">Close</button>
        </div>
    </div>
</div>

<!-- Users Management Modal -->
<div id="usersModal" class="modal-overlay" onclick="if(event.target===this)closeUsersModal()">
    <div class="modal" style="max-width:600px;">
        <h2>User Management</h2>
        <div id="usersTableContainer" style="margin-bottom:16px;">
            <table>
                <thead><tr><th>Username</th><th>2FA</th><th>Status</th><th></th></tr></thead>
                <tbody id="usersTableBody"><tr><td colspan="4">Loading...</td></tr></tbody>
            </table>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:16px;">
            <h3 style="font-size:14px;margin-bottom:12px;">Add User</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <input type="text" id="newUsername" placeholder="Username" style="flex:1;min-width:120px;">
                <input type="password" id="newPassword" placeholder="Password (min 8)" style="flex:1;min-width:120px;">
                <button onclick="createUser()" style="width:auto;">Add</button>
            </div>
        </div>
        <div class="form-actions">
            <button class="secondary" onclick="closeUsersModal()">Close</button>
        </div>
    </div>
</div>

<script>
const API = '/api/v1';
let authToken = '';
let currentUsername = '';
let licenses = [];
let selectedKey = null;
let totpEnabled = false;

(function init() {
    authToken = localStorage.getItem('auth_token') || '';
    if (!authToken) {
        showLogin();
    } else {
        checkAuthStatus();
    }
})();

function showLogin() {
    document.getElementById('loginOverlay').classList.add('visible');
    document.getElementById('changePasswordOverlay').classList.remove('visible');
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginTotp').value = '';
    document.getElementById('loginTotpRow').style.display = 'none';
    document.getElementById('loginError').classList.remove('visible');
    document.getElementById('btnLogout').style.display = 'none';
    document.getElementById('btn2FA').style.display = 'none';
    document.getElementById('btnUsers').style.display = 'none';
    document.getElementById('currentUser').style.display = 'none';
    setTimeout(() => document.getElementById('loginUsername').focus(), 50);
}

async function submitLogin() {
    const errEl = document.getElementById('loginError');
    errEl.classList.remove('visible');

    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    if (!username) { errEl.textContent = 'Username is required'; errEl.classList.add('visible'); return; }
    if (!password) { errEl.textContent = 'Password is required'; errEl.classList.add('visible'); return; }

    const body = { username, password };
    const totpCode = document.getElementById('loginTotp').value.trim();
    if (totpCode) body.totp_code = totpCode;

    try {
        const resp = await fetch(API + '/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        const data = await resp.json();

        if (data.totp_required) {
            document.getElementById('loginTotpRow').style.display = '';
            document.getElementById('loginTotp').focus();
            errEl.textContent = 'Enter your 2FA code';
            errEl.classList.add('visible');
            return;
        }

        if (!resp.ok) {
            errEl.textContent = data.error || 'Login failed';
            errEl.classList.add('visible');
            return;
        }

        authToken = data.token;
        localStorage.setItem('auth_token', authToken);
        totpEnabled = data.totp_enabled;

        if (data.must_change_password) {
            document.getElementById('loginOverlay').classList.remove('visible');
            showChangePassword();
        } else {
            document.getElementById('loginOverlay').classList.remove('visible');
            enterDashboard();
        }
    } catch (e) {
        errEl.textContent = 'Connection failed: ' + e.message;
        errEl.classList.add('visible');
    }
}

function showChangePassword() {
    document.getElementById('changePasswordOverlay').classList.add('visible');
    document.getElementById('cpCurrent').value = '';
    document.getElementById('cpNew').value = '';
    document.getElementById('cpConfirm').value = '';
    document.getElementById('changePasswordError').classList.remove('visible');
    setTimeout(() => document.getElementById('cpCurrent').focus(), 50);
}

async function submitChangePassword() {
    const errEl = document.getElementById('changePasswordError');
    errEl.classList.remove('visible');

    const current = document.getElementById('cpCurrent').value;
    const newPw = document.getElementById('cpNew').value;
    const confirm = document.getElementById('cpConfirm').value;

    if (!current || !newPw) { errEl.textContent = 'All fields are required'; errEl.classList.add('visible'); return; }
    if (newPw.length < 8) { errEl.textContent = 'New password must be at least 8 characters'; errEl.classList.add('visible'); return; }
    if (newPw !== confirm) { errEl.textContent = 'Passwords do not match'; errEl.classList.add('visible'); return; }

    try {
        const resp = await fetch(API + '/auth/change-password', {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ current_password: current, new_password: newPw }),
        });
        if (!resp.ok) {
            const data = await resp.json();
            errEl.textContent = data.error || 'Failed to change password';
            errEl.classList.add('visible');
            return;
        }
        document.getElementById('changePasswordOverlay').classList.remove('visible');
        toast('Password changed successfully', 'success');
        enterDashboard();
    } catch (e) {
        errEl.textContent = 'Connection failed: ' + e.message;
        errEl.classList.add('visible');
    }
}

async function checkAuthStatus() {
    try {
        const resp = await fetch(API + '/auth/status', { headers: authHeaders() });
        if (resp.status === 401) {
            authToken = '';
            localStorage.removeItem('auth_token');
            showLogin();
            return;
        }
        const data = await resp.json();
        totpEnabled = data.totp_enabled;
        currentUsername = data.username || '';
        if (data.must_change_password) {
            showChangePassword();
        } else {
            enterDashboard();
        }
    } catch (e) {
        showLogin();
    }
}

function enterDashboard() {
    document.getElementById('loginOverlay').classList.remove('visible');
    document.getElementById('changePasswordOverlay').classList.remove('visible');
    document.getElementById('btnLogout').style.display = '';
    document.getElementById('btn2FA').style.display = '';
    document.getElementById('btnUsers').style.display = '';
    const userEl = document.getElementById('currentUser');
    userEl.textContent = currentUsername;
    userEl.style.display = '';
    loadLicenses();
}

function logout() {
    authToken = '';
    currentUsername = '';
    localStorage.removeItem('auth_token');
    licenses = [];
    selectedKey = null;
    document.getElementById('licenseTableBody').innerHTML = '<tr><td colspan="7" class="empty-state"><p>Loading...</p></td></tr>';
    closeDetail();
    showLogin();
}

function authHeaders() {
    return { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' };
}

function toast(msg, type) {
    const el = document.createElement('div');
    el.className = 'toast ' + type;
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 4000);
}

function formatDate(iso) {
    if (!iso || iso === 'perpetual') return 'Perpetual';
    const d = new Date(iso);
    return d.toLocaleDateString('en-CA'); // YYYY-MM-DD
}

function getStatus(lic) {
    if (lic.revoked) return 'revoked';
    if (lic.expires !== 'perpetual' && new Date(lic.expires) < new Date()) return 'expired';
    return 'active';
}

async function loadLicenses() {
    const status = document.getElementById('connectionStatus');
    try {
        const resp = await fetch(API + '/licenses', { headers: authHeaders() });
        if (resp.status === 401) {
            status.textContent = 'Session expired';
            status.className = 'status err';
            authToken = '';
            localStorage.removeItem('auth_token');
            showLogin();
            return;
        }
        if (resp.status === 403) {
            showChangePassword();
            return;
        }
        licenses = await resp.json();
        status.textContent = 'Connected';
        status.className = 'status ok';
        renderStats();
        renderTable();
    } catch (e) {
        status.textContent = 'Disconnected';
        status.className = 'status err';
        toast('Failed to connect: ' + e.message, 'error');
    }
}

function renderStats() {
    const total = licenses.length;
    const active = licenses.filter(l => getStatus(l) === 'active').length;
    const expired = licenses.filter(l => getStatus(l) === 'expired').length;
    const revoked = licenses.filter(l => getStatus(l) === 'revoked').length;
    document.getElementById('statTotal').textContent = total;
    document.getElementById('statActive').textContent = active;
    document.getElementById('statExpired').textContent = expired;
    document.getElementById('statRevoked').textContent = revoked;
}

function renderTable() {
    const tbody = document.getElementById('licenseTableBody');
    const search = document.getElementById('searchInput').value.toLowerCase();

    const filtered = licenses.filter(l => {
        if (!search) return true;
        return l.license_key.toLowerCase().includes(search) ||
               l.customer.toLowerCase().includes(search) ||
               l.product.toLowerCase().includes(search) ||
               l.features.some(f => f.toLowerCase().includes(search));
    });

    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><p>No licenses found</p><button onclick="showCreateModal()">Create your first license</button></td></tr>';
        return;
    }

    tbody.innerHTML = filtered.map(l => {
        const status = getStatus(l);
        const features = l.features.map(f => '<span class="feature-tag">' + esc(f) + '</span>').join(' ');
        return '<tr style="cursor:pointer" onclick="selectLicense(\'' + esc(l.license_key) + '\')">' +
            '<td><span class="key-display">' + esc(l.license_key) + '</span></td>' +
            '<td>' + esc(l.customer) + '</td>' +
            '<td>' + esc(l.product) + '</td>' +
            '<td><span class="badge ' + status + '">' + status + '</span></td>' +
            '<td>' + formatDate(l.expires) + '</td>' +
            '<td>' + l.active_machine_count + '/' + (l.max_machines === 0 ? '\u221e' : l.max_machines) + '</td>' +
            '<td>' + (features || '<span style="color:var(--text2)">none</span>') + '</td>' +
            '</tr>';
    }).join('');
}

document.getElementById('searchInput').addEventListener('input', renderTable);

function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

// Detail panel
function selectLicense(key) {
    selectedKey = key;
    const lic = licenses.find(l => l.license_key === key);
    if (!lic) return;

    const status = getStatus(lic);
    document.getElementById('detailTitle').textContent = 'License: ' + lic.customer;
    document.getElementById('detailKey').innerHTML = '<span class="key-display">' + esc(lic.license_key) + '</span>';
    document.getElementById('detailStatus').innerHTML = '<span class="badge ' + status + '">' + status + '</span>';
    document.getElementById('detailProduct').textContent = lic.product;
    document.getElementById('detailCustomer').textContent = lic.customer;
    document.getElementById('detailCreated').textContent = formatDate(lic.created);
    document.getElementById('detailExpires').textContent = formatDate(lic.expires);
    document.getElementById('detailFeatures').innerHTML = lic.features.map(f => '<span class="feature-tag">' + esc(f) + '</span>').join(' ') || 'none';
    document.getElementById('detailMachineCount').textContent = lic.active_machine_count + ' / ' + (lic.max_machines === 0 ? '\u221e' : lic.max_machines);

    const btnRevoke = document.getElementById('btnRevoke');
    btnRevoke.style.display = status === 'revoked' ? 'none' : '';

    const machinesEl = document.getElementById('detailMachines');
    if (lic.machines && lic.machines.length > 0) {
        machinesEl.innerHTML = lic.machines.map(m =>
            '<div class="machine-item">' +
            '<div><strong>' + esc(m.friendly_name || 'Unknown') + '</strong><br><span class="machine-code">' + esc(m.machine_code) + '</span></div>' +
            '<button class="small danger" onclick="deactivateMachine(\'' + esc(lic.license_key) + '\', \'' + esc(m.machine_code) + '\')">Remove</button>' +
            '</div>'
        ).join('');
    } else {
        machinesEl.innerHTML = '<div style="color:var(--text2);font-size:13px;padding:8px 0;">No machines activated</div>';
    }

    document.getElementById('detailPanel').classList.add('visible');
}

function closeDetail() {
    selectedKey = null;
    document.getElementById('detailPanel').classList.remove('visible');
}

// Create modal
function showCreateModal() {
    document.getElementById('createModal').classList.add('visible');
    document.getElementById('createCustomer').focus();
}

function closeCreateModal() {
    document.getElementById('createModal').classList.remove('visible');
}

function updateExpiryFields() {
    const type = document.getElementById('createExpiryType').value;
    const row = document.getElementById('createExpiryValueRow');
    const label = document.getElementById('createExpiryValueLabel');
    const input = document.getElementById('createExpiryValue');
    if (type === 'perpetual') {
        row.style.display = 'none';
    } else if (type === 'days') {
        row.style.display = '';
        label.textContent = 'Days';
        input.type = 'number';
        input.value = '365';
    } else {
        row.style.display = '';
        label.textContent = 'Date (YYYY-MM-DD)';
        input.type = 'date';
        const d = new Date();
        d.setFullYear(d.getFullYear() + 1);
        input.value = d.toISOString().split('T')[0];
    }
}

async function createLicense() {
    const customer = document.getElementById('createCustomer').value.trim();
    if (!customer) { toast('Customer name is required', 'error'); return; }

    const body = {
        product: document.getElementById('createProduct').value.trim() || 'FusionHub',
        customer: customer,
        features: document.getElementById('createFeatures').value.split(',').map(s => s.trim()).filter(Boolean),
        max_machines: parseInt(document.getElementById('createMaxMachines').value) || 0,
    };

    const expiryType = document.getElementById('createExpiryType').value;
    if (expiryType === 'perpetual') {
        body.perpetual = true;
    } else if (expiryType === 'days') {
        body.days = parseInt(document.getElementById('createExpiryValue').value) || 365;
    } else {
        body.expires = document.getElementById('createExpiryValue').value;
    }

    try {
        const resp = await fetch(API + '/licenses', {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify(body),
        });
        if (!resp.ok) {
            const err = await resp.json();
            toast('Error: ' + err.error, 'error');
            return;
        }
        const lic = await resp.json();
        toast('License created: ' + lic.license_key, 'success');
        closeCreateModal();
        await loadLicenses();
        selectLicense(lic.license_key);
    } catch (e) {
        toast('Failed: ' + e.message, 'error');
    }
}

async function revokeLicense() {
    if (!selectedKey) return;
    if (!confirm('Revoke license ' + selectedKey + '? This cannot be undone.')) return;

    try {
        const resp = await fetch(API + '/licenses/' + encodeURIComponent(selectedKey) + '/revoke', {
            method: 'POST',
            headers: authHeaders(),
        });
        if (!resp.ok) {
            const err = await resp.json();
            toast('Error: ' + err.error, 'error');
            return;
        }
        toast('License revoked', 'success');
        closeDetail();
        await loadLicenses();
    } catch (e) {
        toast('Failed: ' + e.message, 'error');
    }
}

async function deactivateMachine(key, machineCode) {
    if (!confirm('Remove machine ' + machineCode.substring(0, 12) + '...?')) return;

    try {
        const resp = await fetch(API + '/licenses/' + encodeURIComponent(key) + '/machines/' + encodeURIComponent(machineCode), {
            method: 'DELETE',
            headers: authHeaders(),
        });
        if (!resp.ok) {
            const err = await resp.json();
            toast('Error: ' + err.error, 'error');
            return;
        }
        toast('Machine deactivated', 'success');
        await loadLicenses();
        selectLicense(key);
    } catch (e) {
        toast('Failed: ' + e.message, 'error');
    }
}

// Export modal
function exportLicense() {
    if (!selectedKey) return;
    document.getElementById('exportKey').value = selectedKey;
    document.getElementById('exportMachineCode').value = '';
    document.getElementById('exportFriendlyName').value = '';
    document.getElementById('exportModal').classList.add('visible');
    document.getElementById('exportMachineCode').focus();
}

function closeExportModal() {
    document.getElementById('exportModal').classList.remove('visible');
}

async function doExport() {
    const key = document.getElementById('exportKey').value;
    const machineCode = document.getElementById('exportMachineCode').value.trim();
    const friendlyName = document.getElementById('exportFriendlyName').value.trim();

    if (!machineCode) { toast('Machine code is required', 'error'); return; }

    try {
        const resp = await fetch(API + '/licenses/' + encodeURIComponent(key) + '/export', {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ machine_code: machineCode, friendly_name: friendlyName }),
        });
        if (!resp.ok) {
            const err = await resp.json();
            toast('Error: ' + err.error, 'error');
            return;
        }
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'license.json';
        a.click();
        URL.revokeObjectURL(url);

        toast('License file exported', 'success');
        closeExportModal();
        await loadLicenses();
        selectLicense(key);
    } catch (e) {
        toast('Failed: ' + e.message, 'error');
    }
}

// 2FA settings
function show2FAModal() {
    const content = document.getElementById('tfaContent');
    if (totpEnabled) {
        content.innerHTML =
            '<p style="margin-bottom:14px;">Two-factor authentication is <strong style="color:var(--green);">enabled</strong>.</p>' +
            '<div class="form-row"><label>Enter current 2FA code to disable</label>' +
            '<input type="text" id="tfaDisableCode" placeholder="6-digit code" maxlength="6" autocomplete="one-time-code"></div>' +
            '<button class="danger" onclick="disable2FA()">Disable 2FA</button>';
    } else {
        content.innerHTML =
            '<p style="margin-bottom:14px;">Two-factor authentication is <strong style="color:var(--text2);">disabled</strong>.</p>' +
            '<button onclick="setup2FA()">Enable 2FA</button>';
    }
    document.getElementById('tfaModal').classList.add('visible');
}

function closeTFAModal() {
    document.getElementById('tfaModal').classList.remove('visible');
}

async function setup2FA() {
    try {
        const resp = await fetch(API + '/auth/setup-2fa', {
            method: 'POST',
            headers: authHeaders(),
        });
        if (!resp.ok) {
            const data = await resp.json();
            toast('Error: ' + data.error, 'error');
            return;
        }
        const data = await resp.json();
        const content = document.getElementById('tfaContent');
        content.innerHTML =
            '<p style="margin-bottom:12px;">Scan this QR code with Google Authenticator:</p>' +
            '<div class="qr-container"><img src="' + data.qr_code + '" alt="QR Code"></div>' +
            '<p style="font-size:12px;color:var(--text2);margin-bottom:4px;">Or enter this secret manually:</p>' +
            '<div class="secret-display">' + esc(data.secret) + '</div>' +
            '<div class="form-row" style="margin-top:16px;"><label>Verification Code</label>' +
            '<input type="text" id="tfaVerifyCode" placeholder="Enter 6-digit code from app" maxlength="6" autocomplete="one-time-code"></div>' +
            '<button onclick="verify2FA()">Verify &amp; Enable</button>';
    } catch (e) {
        toast('Failed: ' + e.message, 'error');
    }
}

async function verify2FA() {
    const code = document.getElementById('tfaVerifyCode').value.trim();
    if (!code) { toast('Enter the 6-digit code', 'error'); return; }

    try {
        const resp = await fetch(API + '/auth/verify-2fa', {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ totp_code: code }),
        });
        if (!resp.ok) {
            const data = await resp.json();
            toast('Error: ' + data.error, 'error');
            return;
        }
        totpEnabled = true;
        toast('2FA enabled successfully', 'success');
        closeTFAModal();
    } catch (e) {
        toast('Failed: ' + e.message, 'error');
    }
}

async function disable2FA() {
    const code = document.getElementById('tfaDisableCode').value.trim();
    if (!code) { toast('Enter your current 2FA code', 'error'); return; }

    try {
        const resp = await fetch(API + '/auth/disable-2fa', {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ totp_code: code }),
        });
        if (!resp.ok) {
            const data = await resp.json();
            toast('Error: ' + data.error, 'error');
            return;
        }
        totpEnabled = false;
        toast('2FA disabled', 'success');
        closeTFAModal();
    } catch (e) {
        toast('Failed: ' + e.message, 'error');
    }
}

// User management
async function showUsersModal() {
    document.getElementById('usersModal').classList.add('visible');
    await loadUsers();
}

function closeUsersModal() {
    document.getElementById('usersModal').classList.remove('visible');
}

async function loadUsers() {
    try {
        const resp = await fetch(API + '/auth/users', { headers: authHeaders() });
        if (!resp.ok) return;
        const users = await resp.json();
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = users.map(u => {
            const isSelf = u.username === currentUsername;
            const status = u.must_change_password ? '<span style="color:var(--yellow);">Must change password</span>' : '<span style="color:var(--green);">Active</span>';
            const tfa = u.totp_enabled ? '<span style="color:var(--green);">Enabled</span>' : '<span style="color:var(--text2);">Off</span>';
            const actions = isSelf
                ? '<span style="color:var(--text2);font-size:11px;">You</span>'
                : '<button class="small secondary" onclick="resetUserPassword(\'' + esc(u.username) + '\')">Reset PW</button> ' +
                  '<button class="small danger" onclick="deleteUser(\'' + esc(u.username) + '\')">Delete</button>';
            return '<tr><td>' + esc(u.username) + '</td><td>' + tfa + '</td><td>' + status + '</td><td style="text-align:right;">' + actions + '</td></tr>';
        }).join('');
    } catch (e) {
        toast('Failed to load users: ' + e.message, 'error');
    }
}

async function createUser() {
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value;
    if (!username) { toast('Username is required', 'error'); return; }
    if (password.length < 8) { toast('Password must be at least 8 characters', 'error'); return; }

    try {
        const resp = await fetch(API + '/auth/users', {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ username, password }),
        });
        if (!resp.ok) {
            const data = await resp.json();
            toast('Error: ' + data.error, 'error');
            return;
        }
        document.getElementById('newUsername').value = '';
        document.getElementById('newPassword').value = '';
        toast('User "' + username + '" created', 'success');
        await loadUsers();
    } catch (e) {
        toast('Failed: ' + e.message, 'error');
    }
}

async function deleteUser(username) {
    if (!confirm('Delete user "' + username + '"? This cannot be undone.')) return;
    try {
        const resp = await fetch(API + '/auth/users/' + encodeURIComponent(username), {
            method: 'DELETE',
            headers: authHeaders(),
        });
        if (!resp.ok) {
            const data = await resp.json();
            toast('Error: ' + data.error, 'error');
            return;
        }
        toast('User deleted', 'success');
        await loadUsers();
    } catch (e) {
        toast('Failed: ' + e.message, 'error');
    }
}

async function resetUserPassword(username) {
    const newPw = prompt('New password for "' + username + '" (min 8 chars):');
    if (!newPw) return;
    if (newPw.length < 8) { toast('Password must be at least 8 characters', 'error'); return; }

    try {
        const resp = await fetch(API + '/auth/users/' + encodeURIComponent(username) + '/reset-password', {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ new_password: newPw }),
        });
        if (!resp.ok) {
            const data = await resp.json();
            toast('Error: ' + data.error, 'error');
            return;
        }
        toast('Password reset for "' + username + '"', 'success');
        await loadUsers();
    } catch (e) {
        toast('Failed: ' + e.message, 'error');
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        closeCreateModal();
        closeExportModal();
        closeTFAModal();
        closeUsersModal();
    }
});
</script>
</body>
</html>
